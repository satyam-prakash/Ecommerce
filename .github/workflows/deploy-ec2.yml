name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests
        run: mvn test
        continue-on-error: true

      - name: Configure AWS credentials (optional)
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "Preparing SSH connection..."
          
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          
          # Add EC2 to known hosts to avoid SSH prompt
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
          
          echo "Uploading JAR file to EC2..."
          scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            target/fashion-retail-app.jar $EC2_USER@$EC2_HOST:/home/$EC2_USER/
          
          echo "Deploying application on EC2..."
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
            echo "=== Starting Deployment ==="
            
            # Stop the service
            echo "Stopping application..."
            sudo systemctl stop fashion-retail || true
            
            # Backup previous version
            if [ -f /opt/fashion-retail/fashion-retail-app.jar ]; then
              echo "Backing up previous version..."
              sudo cp /opt/fashion-retail/fashion-retail-app.jar \
                     /opt/fashion-retail/fashion-retail-app.jar.backup.$(date +%Y%m%d-%H%M%S)
            fi
            
            # Move new JAR
            echo "Installing new version..."
            sudo mv /home/$USER/fashion-retail-app.jar /opt/fashion-retail/
            sudo chown $USER:$USER /opt/fashion-retail/fashion-retail-app.jar
            
            # Start the service
            echo "Starting application..."
            sudo systemctl start fashion-retail
            
            # Wait for startup
            echo "Waiting for application to start..."
            sleep 15
            
            # Check status
            echo "=== Service Status ==="
            sudo systemctl status fashion-retail --no-pager -l || true
            
            # Health check
            echo "=== Health Check ==="
            for i in {1..10}; do
              if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                echo "‚úì Application is healthy!"
                exit 0
              fi
              echo "Waiting for application... ($i/10)"
              sleep 3
            done
            
            echo "‚ö† Application may still be starting. Check logs with:"
            echo "   sudo journalctl -u fashion-retail -f"
          ENDSSH
          
          echo "=== Deployment Complete ==="
          echo "Application URL: http://$EC2_HOST"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key.pem

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above for details."
          exit 1

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üöÄ Application is live at: http://${{ secrets.EC2_HOST }}"
